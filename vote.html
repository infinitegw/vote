<!DOCTYPE html>
<html>
<head>
  <title>Vote</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="logo.png">
</head>
<body onload="loadVotePage()">
  <div class="container">
    <h2>üó≥Ô∏è Cast Your Vote</h2>
    <div id="voteContainer"></div>
    <p>
      <a href="dashboard.html">‚¨Ö Back to Dashboard</a>
    </p>
  </div>

  <script src="script.js"></script>
  <script>
    function loadVotePage() {
      // Check login
      const currentUser = JSON.parse(localStorage.getItem("currentUser"));
      if (!currentUser) {
        alert("You must login first!");
        window.location.href = "login.html";
        return;
      }

      const approved = JSON.parse(localStorage.getItem("approvedCandidates")) || [];
      const votes = JSON.parse(localStorage.getItem("votes")) || {};

      let html = "";
      const grouped = {};

      // Group candidates by post
      approved.forEach(c => {
        if (!grouped[c.post]) grouped[c.post] = [];
        grouped[c.post].push(c);
      });

      // Build UI
      Object.keys(grouped).forEach(post => {
        html += `<h3>${post}</h3><select id="vote_${post}">`;
        html += `<option disabled selected>-- Select Candidate --</option>`;
        grouped[post].forEach(c => {
          html += `<option value="${c.name}">${c.name} (${c.class}, ${c.dorm})</option>`;
        });
        html += `</select><br><br>`;
      });

      html += `<button onclick="castVote()">Submit Vote</button>`;
      document.getElementById("voteContainer").innerHTML = html;
    }

    function castVote() {
      const currentUser = JSON.parse(localStorage.getItem("currentUser"));
      const approved = JSON.parse(localStorage.getItem("approvedCandidates")) || [];
      let votes = JSON.parse(localStorage.getItem("votes")) || {};

      // Ensure votes object has user record
      if (!votes[currentUser.adm]) votes[currentUser.adm] = {};

      const grouped = {};
      approved.forEach(c => {
        if (!grouped[c.post]) grouped[c.post] = [];
        grouped[c.post].push(c);
      });

      let votedSomething = false;

      Object.keys(grouped).forEach(post => {
        const select = document.getElementById("vote_" + post);
        if (select && select.value && !votes[currentUser.adm][post]) {
          votes[currentUser.adm][post] = select.value;
          votedSomething = true;
        }
      });

      if (!votedSomething) {
        alert("You already voted or did not select any candidate!");
        return;
      }

      localStorage.setItem("votes", JSON.stringify(votes));
      alert("‚úÖ Your vote has been recorded!");
      window.location.href = "dashboard.html";
    }
  </script>
</body>
</html>

